<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Impostor Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; text-align: center; padding: 20px; font-size: 22px; }
h1 { font-size: 36px; }
h2 { font-size: 28px; }

input, button {
  padding: 14px;
  margin: 8px;
  font-size: 22px;
  width: 90%;
  max-width: 360px;
}

.hidden { display: none; }
.player-button { display:block; margin:10px auto; font-size:24px; }
.player-button:disabled { background:#ccc; }

.scoreboard { margin-bottom:15px; font-size:20px; }
.timer { font-size:48px; margin:20px; }
.category { font-weight:bold; font-size:24px; }
.target { color:darkred; font-size:24px; }
</style>
</head>

<body>
<h1>Impostor Game</h1>

<!-- SETUP -->
<div id="setup">
  <h2>Add Players</h2>
  <input id="nameInput" placeholder="Player name">
  <button type="button" onclick="addPlayer()">Add Player</button>
  <ul id="playerList"></ul>
  <button type="button" onclick="startGame()">Start Game</button>
</div>

<!-- PLAYER SELECT -->
<div id="playerSelect" class="hidden">
  <div class="scoreboard" id="scoreboard"></div>
  <h2>Select Your Name</h2>
  <div id="playerButtons"></div>
  <button type="button" onclick="startStarterScreen()">Continue</button>
</div>

<!-- ROLE REVEAL -->
<div id="revealScreen" class="hidden">
  <h2 id="revealTitle"></h2>
  <div class="category" id="categoryText"></div>
  <div id="revealText"></div>
  <div class="target" id="targetText"></div>
  <button type="button" onclick="backToSelection()">Done</button>
</div>

<!-- STARTING PLAYER SCREEN -->
<div id="starterScreen" class="hidden">
  <h2>Starting Player</h2>
  <div style="font-size:40px;" id="starterName"></div>
  <button type="button" onclick="startDiscussion()">Start Discussion</button>
</div>

<!-- TIMER -->
<div id="timerScreen" class="hidden">
  <h2 id="timerTitle"></h2>
  <div class="timer" id="timerDisplay"></div>
  <button type="button" onclick="skipTimer()">Skip Countdown</button>
</div>

<!-- ROUND END -->
<div id="roundEnd" class="hidden">
  <h2>Round Result</h2>
  <button onclick="endRound('lost')">Impostor Lost</button>
  <button onclick="endRound('won')">Impostor Won</button>
  <button onclick="endRound('target')">Target Out, No Word (15)</button>
  <button onclick="endRound('targetWord')">Target + Word (45)</button>
  <button onclick="endRound('skip')">Skip Round</button>
</div>

<script>
let players=[], scores={}, data=[], usedWords={}, impostorHistory={};
let impostor="", target="", category="", word="", hint="";
let viewedPlayers=new Set(), timerInterval=null, currentTimerPhase="";

fetch("Impostor.json")
.then(r=>r.json())
.then(json=>{
  data=json;
  data.forEach(o=>usedWords[Object.keys(o)[0]]=new Set());
});

function addPlayer(){
  let n=nameInput.value.trim();
  if(!n||players.includes(n))return;
  players.push(n); scores[n]=0; impostorHistory[n]=[];
  playerList.innerHTML+=`<li>${n}</li>`; nameInput.value="";
}

function startGame(){
  if(players.length<3){alert("Need 3+ players");return;}
  setup.classList.add("hidden");
  newRound();
}

function newRound(){
  viewedPlayers.clear();

  // Weighted impostor selection
  let pool=[];
  players.forEach(p=>{
    let last5=impostorHistory[p].slice(-5);
    let count=last5.filter(x=>x).length;
    let wasLast=last5[last5.length-1]===true;
    if(count>=2)return;

    if(!wasLast) for(let i=0;i<5;i++) pool.push(p);
    else pool.push(p);
  });
  if(pool.length===0) pool=[...players];
  impostor=pool[Math.floor(Math.random()*pool.length)];

  players.forEach(p=>{
    impostorHistory[p].push(p===impostor);
    if(impostorHistory[p].length>5)impostorHistory[p].shift();
  });

  target=players.filter(p=>p!==impostor)[Math.floor(Math.random()*(players.length-1))];
  pickWord();
  updateScoreboard();
  createButtons();
  roundEnd.classList.add("hidden");
  playerSelect.classList.remove("hidden");
}

function pickWord(){
  let obj,avail;
  do{
    obj=data[Math.floor(Math.random()*data.length)];
    category=Object.keys(obj)[0];
    avail=Object.keys(obj[category]).filter(w=>!usedWords[category].has(w));
    if(avail.length===0)usedWords[category].clear();
  }while(avail.length===0);
  word=avail[Math.floor(Math.random()*avail.length)];
  hint=obj[category][word];
  usedWords[category].add(word);
}

function updateScoreboard(){
  scoreboard.innerHTML="Scores:<br>"+players.map(p=>`${p}: ${scores[p]}`).join(" | ");
}

function createButtons(){
  playerButtons.innerHTML="";
  players.forEach(p=>{
    let b=document.createElement("button");
    b.type="button"; b.textContent=p; b.className="player-button";
    b.onclick=()=>reveal(p,b);
    playerButtons.appendChild(b);
  });
}

function reveal(p,b){
  if(viewedPlayers.has(p))return;
  viewedPlayers.add(p); b.disabled=true;
  playerSelect.classList.add("hidden");
  revealScreen.classList.remove("hidden");

  categoryText.textContent=`Category: ${category}`;
  targetText.textContent="";

  if(p===impostor){
    revealTitle.textContent="You are the IMPOSTOR";
    revealText.textContent=`Hint: ${hint}`;
    targetText.textContent=`Target: ${target}`;
  }else{
    revealTitle.textContent="You know the word";
    revealText.textContent=`Word: ${word}`;
  }
}

function backToSelection(){
  revealScreen.classList.add("hidden");
  playerSelect.classList.remove("hidden");
}

function startStarterScreen(){
  let starter=players[Math.floor(Math.random()*players.length)];
  playerSelect.classList.add("hidden");
  starter
